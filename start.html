<script type="text/javascript">
  RED.nodes.registerType('whatsapp-start', {
    category: 'Whatsapp Bot',
    color: '#25D366',
    defaults: {
      name: {
        value: ''
      },
      active:{
        value: false
      },
      client: {
        type: 'whatsapp-session',
        required: true
      },
    },
    button: {
			enabled: function() {
				return !this.changed
			},
      toggle: 'active',
			onclick: function() {
				if (this.changed) {
					return RED.notify(RED._("notification.warning", {message:RED._("notification.warnings.undeployedChanges")}),"warning");
				}
				var label = (this.name||"whatsapp-start");      
				var node = this;

        console.log(this.active)
        
				$.ajax({
					url: "whatsapp-start/"+this.id,
					type:"POST",
          data: {active: this.active},
					success: function(resp) {
						RED.notify(node._("whatsapp-start.success",{label:label}),"success");
					},
					error: function(jqXHR,textStatus,errorThrown) {
						if (jqXHR.status == 404) {
							RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.not-deployed")}),"error");
						} else if (jqXHR.status == 500) {
							RED.notify(node._("common.notification.error",{message:node._("inject.errors.failed")}),"error");
						} else if (jqXHR.status == 0) {
							RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.no-response")}),"error");
						} else {
							RED.notify(node._("common.notification.error",{message:node._("common.notification.errors.unexpected",{status:jqXHR.status,message:textStatus})}),"error");
						}
					}
				});
			}
		},
    inputs: 0,
    outputs: 1,
    align: "left",
    icon: 'whatsapp.png',
    paletteLabel: 'Whatsapp Start',
    label: function () {
      return this.name || 'Whatsapp Start'
    }
  })
</script>


<script type="text/html" data-template-name="whatsapp-start">
  <div class="form-row">
    <label for="node-input-client"><i class="icon-globe"></i> <span> Client</span></label>
    <input type="text" id="node-input-client">
  </div>
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Name">
  </div>
</script>

<script type="text/html" data-help-name="whatsapp-bot">
  <p>Used to send/receive data from a Whatsapp Client. Each Bot node by default subscribes to <code>onMessage</code>, <code>onAck</code> and <code>onAddedToGroup</code> events</p>
  
  <h3>Input</h3>
  <ol class="node-ports">
     <li>Input
      <dl class="message-properties">
        <dt>topic <span class="property-type">String</span></dt>
        <dd>API/Event name</dd>
    </dl>
         <dl class="message-properties">
             <dt>payload <span class="property-type">Array</span></dt>
             <dd>Args to use to call the API</dd>
         </dl>
     </li>
  </ol>

  <h3>Outputs</h3>
  <ol class="node-ports">
     <li>Output
         <dl class="message-properties">
             <dt>payload <span class="property-type">Array</span></dt>
             <dd>Args result of the api/event</dd>
         </dl>
         <dl class="message-properties">
             <dt>topic <span class="property-type">String</span></dt>
             <dd>API name</dd>
         </dl>
     </li>
  </ol>

  <h3>Examples</h3>

  <p>If you want to subscribe to <code>onParticipantsChanged</code> or <code>onLiveLocation</code>, send the request with only the <code>chatId</code> and 
    it will subscribe for those events on that chat. The output <code>msg</code> contain also a property <code>chatId</code> with the id of the chat that has emitted the event</p>

  <p>Function node code for calling <code>sendMessageToId</code> API:</p>
  <code>
    msg.payload = { topic: 'sendMessageToId', payload: [ 'xxxxxxxxxxxx@c.us', 'Hello from Node-Red'] }
    return msg
  </code>

  <p>Result of previous message:</p>
  <code>
    { topic: 'sendMessageToId', payload: [ 'true_xxxxxxxxxx@c.us_xxxxxxxxxxxx' ], origin: { //the origin message request } }
  </code>

 <p>Output for an <code>onMessage</code> event:</p>
 <code>
  { topic: 'onMessage', payload: [ { // the message object } ] }
 </code>
  
  <h3>References</h3>
    <ul>
        <li><a href="https://github.com/danielcardeenas/sulla">APIs</a> - List of available apis</li>
        <li><a href="https://github.com/robertsLando/node-red-contrib-whatsappbot">GitHub</a> - the node github repository</li>
    </ul>
  
  </script>